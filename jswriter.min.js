/*
* JSWriter - v0.1.0
* https://github.com/noeldemartin/jswriter
*/
!function(e){e.fn.JSWriter=function(t){function i(e){var t=b.get(0).selectionStart,i=b.get(0).selectionEnd,a=b.val();b.val(a.substring(0,t)+e+a.substring(i)),b.focus(),b.get(0).selectionStart=b.get(0).selectionEnd=t+e.length,n()}function a(t,a){var r=e('<li><span class="type"><span>'+t.type+'</span></span><span class="id"><input data-id="'+t.id+'" name="asset_ids[]" type="text" value="'+t.id+'"/></span><span class="action"><a class="add">+</a></span><span class="action"><a class="remove">Ã—</a></span></li>'),d=r.find("input");v.find(".assets").append(r),r.append(a),d.on("keyup",function(){var t=e(this),i=t.data("id"),a=t.val();i!=a&&(t.data("id",a),s(i,a))}),r.find("a.add").on("click",function(){var e=y[d.data("id")];i("{{"+e.type+" "+e.id+"}}")}),r.find("a.remove").on("click",function(){l(d.data("id")),r.remove(),o(),n()}),o()}function r(i,a){a="undefined"!=typeof a?a:!1;var r=i.match(/{{.+?}}/g);return r&&e.each(r,function(e,r){var s=r.substring(2,r.indexOf(" ")),l=r.substring(r.indexOf(" ")+1,r.length-2);"image"==s&&(i=a?i.replace(r,'<img src="'+t.buildAssetUrl(y[l])+'" />'):i.replace(r,'<img src="'+y[l].data+'" />'))}),i}function s(e,t){var i=y[e],a=b.val(),r="{{"+i.type+" "+e+"}}",s=new RegExp(r,"g"),l="{{"+i.type+" "+t+"}}";a=a.replace(s,l),b.val(a),i.id=t,y[t]=i,delete y[e]}function l(e){var t=y[e],i=b.val(),a=new RegExp("{{"+t.type+" "+e+"}}","g");i=i.replace(a,""),b.val(i),delete y[e]}function n(){m.html(t.filterText(r(b.val())))}function o(){var e=v.find(".tools"),t=v.find("textarea"),i=v.find(".assets");t.outerHeight(v.height()-e.outerHeight()-i.outerHeight())}function d(){var e=w[0],t=e.requestFullScreen||e.webkitRequestFullScreen||e.mozRequestFullScreen;t.call(e),v.addClass("fullscreen")}function c(t){var i,a=e('<style id="jswriter-styles"></styles'),r="";for(selector in t){r+=selector+"{",i=t[selector];for(prop in i)r+=prop+":"+i[prop]+";";r+="}"}a.text(r),e("head").append(a)}function p(){var e=40,t={".jswriter a":{cursor:"pointer"},".jswriter .editor":{border:"1px solid #aaa",height:"500px"},".jswriter.fullscreen .editor":{},".jswriter .editor-window":{height:"100%",width:"100%","float":"left","overflow-y":"hidden"},".jswriter .editor-text":{padding:"15px"},".jswriter .editor-text:hover":{"overflow-y":"auto"},".jswriter .controls":{width:"100%",height:e+"px"},".jswriter .tabs":{"list-style":"none","padding-left":"0","margin-bottom":"0"},".jswriter .tabs li":{"float":"left",display:"block"},".jswriter .tabs a":{display:"block",height:e+"px","line-height":e+"px",padding:"0 5px","border-radius":"4px 4px 0px 0px",margin:"0 3px",color:"#888","background-color":"#eee","font-size":"1.5rem","text-decoration":"none"},".jswriter .tabs a:hover":{color:"#444","background-color":"#aaa"},".jswriter .tabs .active a":{"font-weight":"bold",color:"#111","background-color":"#aaa"},".jswriter .fullscreen-toggle":{"float":"right","text-decoration":"none",color:"#fff","background-color":"#5bc0de","border-radius":"4px",border:"1px solid #46b8da",padding:"0 5px",margin:"2px",height:e-4+"px","line-height":e-4+"px"},".jswriter .fullscreen-toggle:hover":{"background-color":"#46adcc"},".jswriter .tools":{"list-style":"none","padding-left":"0","margin-bottom":"0","background-color":"#eee"},".jswriter .tools:after":{content:'" "',display:"block",clear:"both"},".jswriter .tools li":{cursor:"pointer","float":"left","background-color":"#fff",border:"1px solid #666","text-align":"center","line-height":"20px",margin:"2px",padding:"0 5px","min-width":"20px",height:"20px"},".jswriter .tools li:hover":{"background-color":"#eee"},".jswriter .tools .bold":{"font-weight":"bold"},".jswriter .tools .italic":{"font-style":"italic"},".jswriter textarea":{width:"100%",border:"0px",resize:"none",background:"#d8d8d8"},".jswriter .assets":{"list-style":"none",padding:"0",margin:"0"},".jswriter .assets li":{display:"table",width:"100%","background-color":"#eee",border:"1px solid #bbb",padding:"5px"},".jswriter .assets .type":{"vertical-align":"middle",display:"table-cell",padding:"0 5px"},".jswriter .assets .type span":{display:"block",color:"white","background-color":"#333",height:"30px",width:"80px","line-height":"30px","text-align":"center"},".jswriter .assets .id":{"vertical-align":"middle",display:"table-cell",width:"100%",padding:"0 5px"},".jswriter .assets .id input":{border:"0","padding-left":"5px","background-color":"#eee",width:"100%",height:"30px"},".jswriter .assets .id input:hover, .jswriter .assets .id input:focus":{"background-color":"#9dc8c5"},".jswriter .assets .action":{display:"table-cell","text-align":"center",width:"34px",padding:"0 2px"},".jswriter .assets .action a":{display:"block","line-height":"30px","font-size":"20px","font-weight":"bold",color:"white","border-radius":"3px",width:"30px",height:"30px","text-decoration":"none"},".jswriter .assets .remove":{"background-color":"#d9534f"},".jswriter .assets .remove:hover":{"background-color":"#d43f3a"},".jswriter .assets .add":{"background-color":"#5cb85C"},".jswriter .assets .add:hover":{"background-color":"#4cae4c"},'.jswriter .assets input[type="file"]':{display:"none"},".jswriter .editor.both .editor-window":{width:"49.5%"},".jswriter .text-preview":{background:"#fff"},".jswriter .separator":{background:"#aaa","float":"left",width:"1%",height:"100%"},".jswriter .editor.preview .separator, .jswriter .editor.preview .text-write":{display:"none"},".jswriter .editor.write .separator, .jswriter .editor.write .text-preview":{display:"none"}};return t}function g(e){return e}function u(e){return"/assets/"+e.id+".png"}var f={text:"",inputName:!1,inputPlaceholder:!1,imagesEnabled:!0,fullscreenEnabled:!0,onTextBold:function(e){e.wrapSelectedText("<strong>","</strong>")},onTextItalic:function(e){e.wrapSelectedText("<em>","</em>")},styles:p(),filterText:g,buildAssetUrl:u},t=e.extend(f,t);t.styles&&0==e("#jswriter-styles").length&&c(t.styles);var h=this,w=e(this),x=e('<div class="controls"><ul class="tabs"><li data-mode="both" class="active"><a>Both</a></li><li data-mode="write"><a>Write</a></li><li data-mode="preview"><a>Preview</a></li></ul><a class="fullscreen-toggle">Fullscreen</a></div>'),v=e('<div class="editor both"><div class="text-write editor-window"><ul class="tools"><li data-action="bold" class="bold">B</li><li data-action="italic" class="italic">I</li><li data-action="upload-image" class="upload-image">upload image</li><li data-action="url-image" class="url-image">url image</li></ul><textarea class="editor-text"></textarea><ul class="assets"></ul></div><div class="separator"></div><div class="text-preview editor-text editor-window"></div></div>'),b=v.find(".text-write textarea"),m=v.find(".text-preview");t.inputName&&b.attr("name",t.inputName),t.inputPlaceholder&&b.attr("placeholder",t.inputPlaceholder),t.imagesEnabled||(v.find(".tools .upload-image").remove(),v.find(".tools .url-image").remove()),t.fullscreenEnabled||x.find(".fullscreen-toggle").remove(),w.addClass("jswriter"),w.prepend(v),w.prepend(x),o();var j="both";x.on("click","li",function(){var t=e(this),i=t.data("mode");i!=j&&(v.removeClass(j),v.addClass(i),x.find(".active").removeClass("active"),t.addClass("active"),j=i)}),x.find(".fullscreen-toggle").click(d),e(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange",o),b.on("keydown",function(e){9==(e.keyCode||e.which)&&(e.preventDefault(),i("  "))}),b.on("keyup",n);var y={};return v.find(".tools").on("click","li",function(){var r=e(this).data("action");if("bold"==r)t.onTextBold(h);else if("italic"==r)t.onTextItalic(h);else if("url-image"==r){var s=prompt("Please enter url","");s&&i('<img src="'+s+'" />')}else if("upload-image"==r){var l=e('<input name="assets[]" type="file" />');l.change(function(){var e=new FileReader;e.onload=function(e){var t=b.get(0).selectionStart,i=b.get(0).selectionEnd,r=b.val(),s=l.val(),o=l[0].files[0].type;o=o.substring(o.indexOf("/")+1),s=s.substring(0,s.lastIndexOf(".")),s=s.replace(new RegExp("[^\\w\\d-_]","g"),""),y[s]={type:"image",id:s,extension:o,data:e.target.result},b.val(r.substring(0,t)+"{{image "+s+"}}"+r.substring(i)),n(),a(y[s],l)},e.readAsDataURL(l[0].files[0])}),l.trigger("click")}}),w.on("submit",function(){var i=e('<input name="text_original" type="hidden" />'),a=e('<input name="text_html" type="hidden" />');w.append(i),w.append(a),i.val(r(b.val(),!0)),a.val(t.filterText(r(b.val(),!0)))}),t.text.length>0&&(b.text(t.text),m.html(t.filterText(r(t.text)))),this.wrapSelectedText=function(e,t){var i=b.get(0).selectionStart,a=b.get(0).selectionEnd,r=b.val();b.val(r.substring(0,i)+e+r.substring(i,a)+t+r.substring(a)),n(),b.focus(),b.get(0).selectionStart=b.get(0).selectionEnd=a+e.length+t.length},this}}(jQuery);