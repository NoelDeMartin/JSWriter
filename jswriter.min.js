/* https://github.com/noeldemartin/jswriter */
!function(e){e.fn.JSWriter=function(t){function i(e,t){var i=x.get(0).selectionStart,r=x.get(0).selectionEnd,a=x.val();x.val(a.substring(0,i)+e+a.substring(i,r)+t+a.substring(r)),s(),x.focus(),x.get(0).selectionStart=x.get(0).selectionEnd=r+e.length+t.length}function r(e){var t=x.get(0).selectionStart,i=x.get(0).selectionEnd,r=x.val();x.val(r.substring(0,t)+e+r.substring(i)),x.focus(),x.get(0).selectionStart=x.get(0).selectionEnd=t+e.length,s()}function a(e){h.find(".assets").append('<li><span class="type">'+e.type+"</span>"+e.id+"</li>"),l()}function o(t){var i=t.match(/{{.+?}}/g);return i&&e.each(i,function(e,i){var r=i.substring(2,i.indexOf(" ")),a=i.substring(i.indexOf(" ")+1,i.length-2);"image"==r&&(t=t.replace(i,'<img src="'+m[a].data+'" />'))}),t}function s(){v.html(t.filterText(o(x.val())))}function l(){var e=h.find(".tools"),t=h.find("textarea"),i=h.find(".assets");t.outerHeight(h.height()-e.outerHeight()-i.outerHeight())}function n(){var e=f[0],t=e.requestFullScreen||e.webkitRequestFullScreen||e.mozRequestFullScreen;t.call(e)}function d(t){var i,r=e('<style id="jswriter-styles"></styles'),a="";for(selector in t){a+=selector+"{",i=t[selector];for(prop in i)a+=prop+":"+i[prop]+";";a+="}"}r.text(a),e("head").append(r)}function c(){var e=40,t={".jswriter a":{cursor:"pointer"},".jswriter .editor":{border:"1px solid #aaa",height:"500px"},".jswriter .editor-window":{height:"100%",width:"100%","float":"left","overflow-y":"hidden"},".jswriter .editor-text":{padding:"15px"},".jswriter .editor-text:hover":{"overflow-y":"auto"},".jswriter .controls":{width:"100%",height:e+"px"},".jswriter .tabs":{"list-style":"none","padding-left":"0","margin-bottom":"0"},".jswriter .tabs li":{"float":"left",display:"block"},".jswriter .tabs a":{display:"block",height:e+"px","line-height":e+"px",padding:"0 5px","border-radius":"4px 4px 0px 0px",margin:"0 3px",color:"#888","background-color":"#eee","font-size":"1.5rem","text-decoration":"none"},".jswriter .tabs a:hover":{color:"#444","background-color":"#aaa"},".jswriter .tabs .active a":{"font-weight":"bold",color:"#111","background-color":"#aaa"},".jswriter .fullscreen":{"float":"right","text-decoration":"none",color:"#fff","background-color":"#5bc0de","border-radius":"4px",border:"1px solid #46b8da",padding:"0 5px",margin:"2px",height:e-4+"px","line-height":e-4+"px"},".jswriter .fullscreen:hover":{"background-color":"#46adcc"},".jswriter .tools":{"list-style":"none","padding-left":"0","margin-bottom":"0","background-color":"#eee"},".jswriter .tools:after":{content:'" "',display:"block",clear:"both"},".jswriter .tools li":{cursor:"pointer","float":"left","background-color":"#fff",border:"1px solid #666","text-align":"center","line-height":"20px",margin:"2px",padding:"0 5px","min-width":"20px",height:"20px"},".jswriter .tools li:hover":{"background-color":"#eee"},".jswriter .tools .bold":{"font-weight":"bold"},".jswriter .tools .italic":{"font-style":"italic"},".jswriter textarea":{width:"100%",border:"0px",resize:"none",background:"#d8d8d8"},".jswriter .assets":{"list-style":"none",padding:0,margin:0},".jswriter .assets li":{"background-color":"#eee",border:"1px solid #bbb",padding:"5px"},".jswriter .assets .type":{"background-color":"#333",color:"#fff",padding:"3px","margin-right":"5px"},".jswriter .editor.both .editor-window":{width:"49.5%"},".jswriter .text-preview":{background:"#fff"},".jswriter .separator":{background:"#aaa","float":"left",width:"1%",height:"100%"},".jswriter .editor.preview .separator, .jswriter .editor.preview .text-write":{display:"none"},".jswriter .editor.write .separator, .jswriter .editor.write .text-preview":{display:"none"}};return t}function u(e){return e}function g(){return e('<input type="file" />')}var p={text:"",styles:c(),filterText:u,createFileInput:g},t=e.extend(p,t);t.styles&&0==e("#jswriter-styles").length&&d(t.styles);var f=e(this),w=e('<div class="controls"><ul class="tabs"><li data-mode="both" class="active"><a>Both</a></li><li data-mode="write"><a>Write</a></li><li data-mode="preview"><a>Preview</a></li></ul><a class="fullscreen">Fullscreen</a></div>'),h=e('<div class="editor both"><div class="text-write editor-window"><ul class="tools"><li data-action="bold" class="bold">B</li><li data-action="italic" class="italic">I</li><li data-action="upload-image" class="upload-image">upload image</li><li data-action="url-image" class="url-image">url image</li></ul><textarea name="text_markdown" class="editor-text"></textarea><ul class="assets"></ul></div><div class="separator"></div><div class="text-preview editor-text editor-window"></div></div>'),x=h.find(".text-write textarea"),v=h.find(".text-preview");f.addClass("jswriter"),f.append(w),f.append(h),l();var b="both";w.on("click","li",function(){var t=e(this),i=t.data("mode");i!=b&&(h.removeClass(b),h.addClass(i),w.find(".active").removeClass("active"),t.addClass("active"),b=i)}),w.find(".fullscreen").click(n),x.on("keydown",function(e){9==(e.keyCode||e.which)&&(e.preventDefault(),r("	"))}),x.on("keyup",s);var m={};return h.find(".tools").on("click","li",function(){var o=e(this).data("action");if("bold"==o)i("<strong>","</strong>");else if("italic"==o)i("<em>","</em>");else if("url-image"==o){var l=prompt("Please enter url","");l&&r('<img src="'+l+'" />')}else if("upload-image"==o){var n=t.createFileInput();n.change(function(){var e=new FileReader;e.onload=function(e){var t=x.get(0).selectionStart,i=x.get(0).selectionEnd,r=x.val(),o=n.val();m[o]={type:"image",id:o,data:e.target.result,input:n},x.val(r.substring(0,t)+"{{image "+o+"}}"+r.substring(i)),s(),a(m[o])},e.readAsDataURL(n[0].files[0])}),n.trigger("click")}}),t.text.length>0&&(x.text(t.text),v.html(t.filterText(o(t.text)))),this.getData=function(){var e=x.val();return{input:e,output:t.filterText(o(e)),assets:m}},this}}(jQuery);