/* https://github.com/noeldemartin/jswriter */
!function(e){e.fn.JSWriter=function(t){function i(e,t){var i=x.get(0).selectionStart,r=x.get(0).selectionEnd,a=x.val();x.val(a.substring(0,i)+e+a.substring(i,r)+t+a.substring(r)),n(),x.focus(),x.get(0).selectionStart=x.get(0).selectionEnd=r+e.length+t.length}function r(e){var t=x.get(0).selectionStart,i=x.get(0).selectionEnd,r=x.val();x.val(r.substring(0,t)+e+r.substring(i)),x.focus(),x.get(0).selectionStart=x.get(0).selectionEnd=t+e.length,n()}function a(t){var i=e('<li><span class="type"><span>'+t.type+'</span></span><span class="id"><input data-id="'+t.id+'" name="asset_ids[]" type="text" value="'+t.id+'"/></span><span class="action"><a class="add">+</a></span><span class="action"><a class="remove">Ã—</a></span></li>'),a=i.find("input");v.find(".assets").append(i),a.on("keyup",function(){var t=e(this),i=t.data("id"),r=t.val();i!=r&&(t.data("id",r),o(i,r))}),i.find("a.add").on("click",function(){var e=j[a.data("id")];r("{{"+e.type+" "+e.id+"}}")}),i.find("a.remove").on("click",function(){l(a.data("id")),i.remove(),d(),n()}),d()}function s(t){var i=t.match(/{{.+?}}/g);return i&&e.each(i,function(e,i){var r=i.substring(2,i.indexOf(" ")),a=i.substring(i.indexOf(" ")+1,i.length-2);"image"==r&&(t=t.replace(i,'<img src="'+j[a].data+'" />'))}),t}function o(e,t){var i=j[e],r=x.val(),a="{{"+i.type+" "+e+"}}",s=new RegExp(a,"g"),o="{{"+i.type+" "+t+"}}";r=r.replace(s,o),x.val(r),i.id=t,j[t]=i,delete j[e]}function l(e){var t=j[e],i=x.val(),r=new RegExp("{{"+t.type+" "+e+"}}","g");i=i.replace(r,""),x.val(i),delete j[e]}function n(){b.html(t.filterText(s(x.val())))}function d(){var e=v.find(".tools"),t=v.find("textarea"),i=v.find(".assets");t.outerHeight(v.height()-e.outerHeight()-i.outerHeight())}function c(){var e=w[0],t=e.requestFullScreen||e.webkitRequestFullScreen||e.mozRequestFullScreen;t.call(e),v.addClass("fullscreen")}function p(t){var i,r=e('<style id="jswriter-styles"></styles'),a="";for(selector in t){a+=selector+"{",i=t[selector];for(prop in i)a+=prop+":"+i[prop]+";";a+="}"}r.text(a),e("head").append(r)}function g(){var e=40,t={".jswriter a":{cursor:"pointer"},".jswriter .editor":{border:"1px solid #aaa",height:"500px"},".jswriter.fullscreen .editor":{},".jswriter .editor-window":{height:"100%",width:"100%","float":"left","overflow-y":"hidden"},".jswriter .editor-text":{padding:"15px"},".jswriter .editor-text:hover":{"overflow-y":"auto"},".jswriter .controls":{width:"100%",height:e+"px"},".jswriter .tabs":{"list-style":"none","padding-left":"0","margin-bottom":"0"},".jswriter .tabs li":{"float":"left",display:"block"},".jswriter .tabs a":{display:"block",height:e+"px","line-height":e+"px",padding:"0 5px","border-radius":"4px 4px 0px 0px",margin:"0 3px",color:"#888","background-color":"#eee","font-size":"1.5rem","text-decoration":"none"},".jswriter .tabs a:hover":{color:"#444","background-color":"#aaa"},".jswriter .tabs .active a":{"font-weight":"bold",color:"#111","background-color":"#aaa"},".jswriter .fullscreen-toggle":{"float":"right","text-decoration":"none",color:"#fff","background-color":"#5bc0de","border-radius":"4px",border:"1px solid #46b8da",padding:"0 5px",margin:"2px",height:e-4+"px","line-height":e-4+"px"},".jswriter .fullscreen-toggle:hover":{"background-color":"#46adcc"},".jswriter .tools":{"list-style":"none","padding-left":"0","margin-bottom":"0","background-color":"#eee"},".jswriter .tools:after":{content:'" "',display:"block",clear:"both"},".jswriter .tools li":{cursor:"pointer","float":"left","background-color":"#fff",border:"1px solid #666","text-align":"center","line-height":"20px",margin:"2px",padding:"0 5px","min-width":"20px",height:"20px"},".jswriter .tools li:hover":{"background-color":"#eee"},".jswriter .tools .bold":{"font-weight":"bold"},".jswriter .tools .italic":{"font-style":"italic"},".jswriter textarea":{width:"100%",border:"0px",resize:"none",background:"#d8d8d8"},".jswriter .assets":{"list-style":"none",padding:"0",margin:"0"},".jswriter .assets li":{display:"table",width:"100%","background-color":"#eee",border:"1px solid #bbb",padding:"5px"},".jswriter .assets .type":{"vertical-align":"middle",display:"table-cell",padding:"0 5px"},".jswriter .assets .type span":{display:"block",color:"white","background-color":"#333",height:"30px",width:"80px","line-height":"30px","text-align":"center"},".jswriter .assets .id":{"vertical-align":"middle",display:"table-cell",width:"100%",padding:"0 5px"},".jswriter .assets .id input":{border:"0","padding-left":"5px","background-color":"#eee",width:"100%",height:"30px"},".jswriter .assets .id input:hover, .jswriter .assets .id input:focus":{"background-color":"#9dc8c5"},".jswriter .assets .action":{display:"table-cell","text-align":"center",width:"34px",padding:"0 2px"},".jswriter .assets .action a":{display:"block","line-height":"30px","font-size":"20px","font-weight":"bold",color:"white","border-radius":"3px",width:"30px",height:"30px","text-decoration":"none"},".jswriter .assets .remove":{"background-color":"#d9534f"},".jswriter .assets .remove:hover":{"background-color":"#d43f3a"},".jswriter .assets .add":{"background-color":"#5cb85C"},".jswriter .assets .add:hover":{"background-color":"#4cae4c"},".jswriter .editor.both .editor-window":{width:"49.5%"},".jswriter .text-preview":{background:"#fff"},".jswriter .separator":{background:"#aaa","float":"left",width:"1%",height:"100%"},".jswriter .editor.preview .separator, .jswriter .editor.preview .text-write":{display:"none"},".jswriter .editor.write .separator, .jswriter .editor.write .text-preview":{display:"none"}};return t}function u(e){return e}var f={text:"",styles:g(),filterText:u},t=e.extend(f,t);t.styles&&0==e("#jswriter-styles").length&&p(t.styles);var w=e(this),h=e('<div class="controls"><ul class="tabs"><li data-mode="both" class="active"><a>Both</a></li><li data-mode="write"><a>Write</a></li><li data-mode="preview"><a>Preview</a></li></ul><a class="fullscreen-toggle">Fullscreen</a></div>'),v=e('<div class="editor both"><div class="text-write editor-window"><ul class="tools"><li data-action="bold" class="bold">B</li><li data-action="italic" class="italic">I</li><li data-action="upload-image" class="upload-image">upload image</li><li data-action="url-image" class="url-image">url image</li></ul><textarea name="text_markdown" class="editor-text"></textarea><ul class="assets"></ul></div><div class="separator"></div><div class="text-preview editor-text editor-window"></div></div>'),x=v.find(".text-write textarea"),b=v.find(".text-preview");w.addClass("jswriter"),w.append(h),w.append(v),d();var m="both";h.on("click","li",function(){var t=e(this),i=t.data("mode");i!=m&&(v.removeClass(m),v.addClass(i),h.find(".active").removeClass("active"),t.addClass("active"),m=i)}),h.find(".fullscreen-toggle").click(c),e(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange",d),x.on("keydown",function(e){9==(e.keyCode||e.which)&&(e.preventDefault(),r("	"))}),x.on("keyup",n);var j={};return v.find(".tools").on("click","li",function(){var t=e(this).data("action");if("bold"==t)i("<strong>","</strong>");else if("italic"==t)i("<em>","</em>");else if("url-image"==t){var s=prompt("Please enter url","");s&&r('<img src="'+s+'" />')}else if("upload-image"==t){var o=e('<input name="assets[]" type="file" />');o.change(function(){var e=new FileReader;e.onload=function(e){var t=x.get(0).selectionStart,i=x.get(0).selectionEnd,r=x.val(),s=o.val();j[s]={type:"image",id:s,data:e.target.result},x.val(r.substring(0,t)+"{{image "+s+"}}"+r.substring(i)),n(),a(j[s])},e.readAsDataURL(o[0].files[0])}),o.trigger("click")}}),t.text.length>0&&(x.text(t.text),b.html(t.filterText(s(t.text)))),this.getData=function(){var e=x.val();return{input:e,output:t.filterText(s(e)),assets:j}},this}}(jQuery);