!function(t){t.fn.JSWriter=function(e){function i(t,e){var i=h.get(0).selectionStart,r=h.get(0).selectionEnd,a=h.val();h.val(a.substring(0,i)+t+a.substring(i,r)+e+a.substring(r))}function r(t){w.find(".assets").append('<li><span class="type">'+t.type+"</span>"+t.id+"</li>"),s()}function a(e){var i=e.match(/{{.+?}}/g);return i&&t.each(i,function(t,i){var r=i.substring(2,i.indexOf(" ")),a=i.substring(i.indexOf(" ")+1,i.length-2);"image"==r&&(e=e.replace(i,'<img src="'+b[a].data+'" />'))}),e}function o(){x.html(e.filterText(a(h.val())))}function s(){var t=w.find(".tools"),e=w.find("textarea"),i=w.find(".assets");e.outerHeight(w.height()-t.outerHeight()-i.outerHeight())}function l(){var t=u[0],e=t.requestFullScreen||t.webkitRequestFullScreen||t.mozRequestFullScreen;e.call(t)}function n(e){var i,r=t('<style id="jswriter-styles"></styles'),a="";for(selector in e){a+=selector+"{",i=e[selector];for(prop in i)a+=prop+":"+i[prop]+";";a+="}"}r.text(a),t("head").append(r)}function d(){var t=40,e={".jswriter a":{cursor:"pointer"},".jswriter .editor":{border:"1px solid #aaa",height:"500px"},".jswriter .editor-window":{height:"100%",width:"100%","float":"left","overflow-y":"hidden"},".jswriter .editor-text":{padding:"15px"},".jswriter .editor-text:hover":{"overflow-y":"auto"},".jswriter .controls":{width:"100%",height:t+"px"},".jswriter .tabs":{"list-style":"none","padding-left":"0","margin-bottom":"0"},".jswriter .tabs li":{"float":"left",display:"block"},".jswriter .tabs a":{display:"block",height:t+"px","line-height":t+"px",padding:"0 5px","border-radius":"4px 4px 0px 0px",margin:"0 3px",color:"#888","background-color":"#eee","font-size":"1.5rem","text-decoration":"none"},".jswriter .tabs a:hover":{color:"#444","background-color":"#aaa"},".jswriter .tabs .active a":{"font-weight":"bold",color:"#111","background-color":"#aaa"},".jswriter .fullscreen":{"float":"right","text-decoration":"none",color:"#fff","background-color":"#5bc0de","border-radius":"4px",border:"1px solid #46b8da",padding:"0 5px",margin:"2px",height:t-4+"px","line-height":t-4+"px"},".jswriter .fullscreen:hover":{"background-color":"#46adcc"},".jswriter .tools":{"list-style":"none","padding-left":"0","margin-bottom":"0","background-color":"#eee"},".jswriter .tools:after":{content:'" "',display:"block",clear:"both"},".jswriter .tools li":{cursor:"pointer","float":"left","background-color":"#fff",border:"1px solid #666","text-align":"center","line-height":"20px",margin:"2px",padding:"0 5px","min-width":"20px",height:"20px"},".jswriter .tools li:hover":{"background-color":"#eee"},".jswriter .tools .bold":{"font-weight":"bold"},".jswriter .tools .italic":{"font-style":"italic"},".jswriter textarea":{width:"100%",border:"0px",resize:"none",background:"#d8d8d8"},".jswriter .assets":{"list-style":"none",padding:0,margin:0},".jswriter .assets li":{"background-color":"#eee",border:"1px solid #bbb",padding:"5px"},".jswriter .assets .type":{"background-color":"#333",color:"#fff",padding:"3px","margin-right":"5px"},".jswriter .editor.both .editor-window":{width:"49.5%"},".jswriter .text-preview":{background:"#fff"},".jswriter .separator":{background:"#aaa","float":"left",width:"1%",height:"100%"},".jswriter .editor.preview .separator, .jswriter .editor.preview .text-write":{display:"none"},".jswriter .editor.write .separator, .jswriter .editor.write .text-preview":{display:"none"}};return e}function c(t){return t}function p(){return t('<input type="file" />')}var g={text:"",styles:d(),filterText:c,createFileInput:p},e=t.extend(g,e);e.styles&&0==t("#jswriter-styles").length&&n(e.styles);var u=t(this),f=t('<div class="controls"><ul class="tabs"><li data-mode="both" class="active"><a>Both</a></li><li data-mode="write"><a>Write</a></li><li data-mode="preview"><a>Preview</a></li></ul><a class="fullscreen">Fullscreen</a></div>'),w=t('<div class="editor both"><div class="text-write editor-window"><ul class="tools"><li data-action="bold" class="bold">B</li><li data-action="italic" class="italic">I</li><li data-action="image" class="image">image</li></ul><textarea name="text_markdown" class="editor-text"></textarea><ul class="assets"></ul></div><div class="separator"></div><div class="text-preview editor-text editor-window"></div></div>'),h=w.find(".text-write textarea"),x=w.find(".text-preview");u.addClass("jswriter"),u.append(f),u.append(w),s();var v="both";f.on("click","li",function(){var e=t(this),i=e.data("mode");i!=v&&(w.removeClass(v),w.addClass(i),f.find(".active").removeClass("active"),e.addClass("active"),v=i)}),f.find(".fullscreen").click(l),h.on("keydown",function(t){if(9==(t.keyCode||t.which)){t.preventDefault();var e=h.get(0).selectionStart,i=h.get(0).selectionEnd;h.val(h.val().substring(0,e)+"	"+h.val().substring(i)),h.get(0).selectionStart=h.get(0).selectionEnd=e+1}}),h.on("keyup",o);var b={};return w.find(".tools").on("click","li",function(){var a=t(this).data("action");if("bold"==a)i("<strong>","</strong>"),o();else if("italic"==a)i("<em>","</em>"),o();else if("image"==a){var s=e.createFileInput();s.change(function(){var t=new FileReader;t.onload=function(t){var e=h.get(0).selectionStart,i=h.get(0).selectionEnd,a=h.val(),l=s.val();b[l]={type:"image",id:l,data:t.target.result,input:s},h.val(a.substring(0,e)+"{{image "+l+"}}"+a.substring(i)),o(),r(b[l])},t.readAsDataURL(s[0].files[0])}),s.trigger("click")}}),e.text.length>0&&(h.text(e.text),x.html(e.filterText(a(e.text)))),this.getData=function(){var t=h.val();return{input:t,output:e.filterText(a(t)),assets:b}},this}}(jQuery);