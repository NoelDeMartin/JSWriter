/* https://github.com/noeldemartin/jswriter */
!function(e){e.fn.JSWriter=function(t){function i(e,t){var i=b.get(0).selectionStart,r=b.get(0).selectionEnd,a=b.val();b.val(a.substring(0,i)+e+a.substring(i,r)+t+a.substring(r)),n(),b.focus(),b.get(0).selectionStart=b.get(0).selectionEnd=r+e.length+t.length}function r(e){var t=b.get(0).selectionStart,i=b.get(0).selectionEnd,r=b.val();b.val(r.substring(0,t)+e+r.substring(i)),b.focus(),b.get(0).selectionStart=b.get(0).selectionEnd=t+e.length,n()}function a(t,i){var a=e('<li><span class="type"><span>'+t.type+'</span></span><span class="id"><input data-id="'+t.id+'" name="asset_ids[]" type="text" value="'+t.id+'"/></span><span class="action"><a class="add">+</a></span><span class="action"><a class="remove">Ã—</a></span></li>'),s=a.find("input");v.find(".assets").append(a),a.append(i),s.on("keyup",function(){var t=e(this),i=t.data("id"),r=t.val();i!=r&&(t.data("id",r),l(i,r))}),a.find("a.add").on("click",function(){var e=y[s.data("id")];r("{{"+e.type+" "+e.id+"}}")}),a.find("a.remove").on("click",function(){o(s.data("id")),a.remove(),d(),n()}),d()}function s(i,r){r="undefined"!=typeof r?r:!1;var a=i.match(/{{.+?}}/g);return a&&e.each(a,function(e,a){var s=a.substring(2,a.indexOf(" ")),l=a.substring(a.indexOf(" ")+1,a.length-2);"image"==s&&(i=r?i.replace(a,'<img src="'+t.buildAssetUrl(y[l])+'" />'):i.replace(a,'<img src="'+y[l].data+'" />'))}),i}function l(e,t){var i=y[e],r=b.val(),a="{{"+i.type+" "+e+"}}",s=new RegExp(a,"g"),l="{{"+i.type+" "+t+"}}";r=r.replace(s,l),b.val(r),i.id=t,y[t]=i,delete y[e]}function o(e){var t=y[e],i=b.val(),r=new RegExp("{{"+t.type+" "+e+"}}","g");i=i.replace(r,""),b.val(i),delete y[e]}function n(){m.html(t.filterText(s(b.val())))}function d(){var e=v.find(".tools"),t=v.find("textarea"),i=v.find(".assets");t.outerHeight(v.height()-e.outerHeight()-i.outerHeight())}function c(){var e=h[0],t=e.requestFullScreen||e.webkitRequestFullScreen||e.mozRequestFullScreen;t.call(e),v.addClass("fullscreen")}function p(t){var i,r=e('<style id="jswriter-styles"></styles'),a="";for(selector in t){a+=selector+"{",i=t[selector];for(prop in i)a+=prop+":"+i[prop]+";";a+="}"}r.text(a),e("head").append(r)}function g(){var e=40,t={".jswriter a":{cursor:"pointer"},".jswriter .editor":{border:"1px solid #aaa",height:"500px"},".jswriter.fullscreen .editor":{},".jswriter .editor-window":{height:"100%",width:"100%","float":"left","overflow-y":"hidden"},".jswriter .editor-text":{padding:"15px"},".jswriter .editor-text:hover":{"overflow-y":"auto"},".jswriter .controls":{width:"100%",height:e+"px"},".jswriter .tabs":{"list-style":"none","padding-left":"0","margin-bottom":"0"},".jswriter .tabs li":{"float":"left",display:"block"},".jswriter .tabs a":{display:"block",height:e+"px","line-height":e+"px",padding:"0 5px","border-radius":"4px 4px 0px 0px",margin:"0 3px",color:"#888","background-color":"#eee","font-size":"1.5rem","text-decoration":"none"},".jswriter .tabs a:hover":{color:"#444","background-color":"#aaa"},".jswriter .tabs .active a":{"font-weight":"bold",color:"#111","background-color":"#aaa"},".jswriter .fullscreen-toggle":{"float":"right","text-decoration":"none",color:"#fff","background-color":"#5bc0de","border-radius":"4px",border:"1px solid #46b8da",padding:"0 5px",margin:"2px",height:e-4+"px","line-height":e-4+"px"},".jswriter .fullscreen-toggle:hover":{"background-color":"#46adcc"},".jswriter .tools":{"list-style":"none","padding-left":"0","margin-bottom":"0","background-color":"#eee"},".jswriter .tools:after":{content:'" "',display:"block",clear:"both"},".jswriter .tools li":{cursor:"pointer","float":"left","background-color":"#fff",border:"1px solid #666","text-align":"center","line-height":"20px",margin:"2px",padding:"0 5px","min-width":"20px",height:"20px"},".jswriter .tools li:hover":{"background-color":"#eee"},".jswriter .tools .bold":{"font-weight":"bold"},".jswriter .tools .italic":{"font-style":"italic"},".jswriter textarea":{width:"100%",border:"0px",resize:"none",background:"#d8d8d8"},".jswriter .assets":{"list-style":"none",padding:"0",margin:"0"},".jswriter .assets li":{display:"table",width:"100%","background-color":"#eee",border:"1px solid #bbb",padding:"5px"},".jswriter .assets .type":{"vertical-align":"middle",display:"table-cell",padding:"0 5px"},".jswriter .assets .type span":{display:"block",color:"white","background-color":"#333",height:"30px",width:"80px","line-height":"30px","text-align":"center"},".jswriter .assets .id":{"vertical-align":"middle",display:"table-cell",width:"100%",padding:"0 5px"},".jswriter .assets .id input":{border:"0","padding-left":"5px","background-color":"#eee",width:"100%",height:"30px"},".jswriter .assets .id input:hover, .jswriter .assets .id input:focus":{"background-color":"#9dc8c5"},".jswriter .assets .action":{display:"table-cell","text-align":"center",width:"34px",padding:"0 2px"},".jswriter .assets .action a":{display:"block","line-height":"30px","font-size":"20px","font-weight":"bold",color:"white","border-radius":"3px",width:"30px",height:"30px","text-decoration":"none"},".jswriter .assets .remove":{"background-color":"#d9534f"},".jswriter .assets .remove:hover":{"background-color":"#d43f3a"},".jswriter .assets .add":{"background-color":"#5cb85C"},".jswriter .assets .add:hover":{"background-color":"#4cae4c"},'.jswriter .assets input[type="file"]':{display:"none"},".jswriter .editor.both .editor-window":{width:"49.5%"},".jswriter .text-preview":{background:"#fff"},".jswriter .separator":{background:"#aaa","float":"left",width:"1%",height:"100%"},".jswriter .editor.preview .separator, .jswriter .editor.preview .text-write":{display:"none"},".jswriter .editor.write .separator, .jswriter .editor.write .text-preview":{display:"none"}};return t}function u(e){return e}function f(e){return"/assets/"+e.id+".png"}var w={text:"",styles:g(),filterText:u,buildAssetUrl:f},t=e.extend(w,t);t.styles&&0==e("#jswriter-styles").length&&p(t.styles);var h=e(this),x=e('<div class="controls"><ul class="tabs"><li data-mode="both" class="active"><a>Both</a></li><li data-mode="write"><a>Write</a></li><li data-mode="preview"><a>Preview</a></li></ul><a class="fullscreen-toggle">Fullscreen</a></div>'),v=e('<div class="editor both"><div class="text-write editor-window"><ul class="tools"><li data-action="bold" class="bold">B</li><li data-action="italic" class="italic">I</li><li data-action="upload-image" class="upload-image">upload image</li><li data-action="url-image" class="url-image">url image</li></ul><textarea class="editor-text"></textarea><ul class="assets"></ul></div><div class="separator"></div><div class="text-preview editor-text editor-window"></div></div>'),b=v.find(".text-write textarea"),m=v.find(".text-preview");h.addClass("jswriter"),h.prepend(v),h.prepend(x),d();var j="both";x.on("click","li",function(){var t=e(this),i=t.data("mode");i!=j&&(v.removeClass(j),v.addClass(i),x.find(".active").removeClass("active"),t.addClass("active"),j=i)}),x.find(".fullscreen-toggle").click(c),e(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange",d),b.on("keydown",function(e){9==(e.keyCode||e.which)&&(e.preventDefault(),r("	"))}),b.on("keyup",n);var y={};return v.find(".tools").on("click","li",function(){var t=e(this).data("action");if("bold"==t)i("<strong>","</strong>");else if("italic"==t)i("<em>","</em>");else if("url-image"==t){var s=prompt("Please enter url","");s&&r('<img src="'+s+'" />')}else if("upload-image"==t){var l=e('<input name="assets[]" type="file" />');l.change(function(){var e=new FileReader;e.onload=function(e){var t=b.get(0).selectionStart,i=b.get(0).selectionEnd,r=b.val(),s=l.val(),o=l[0].files[0].type;o=o.substring(o.indexOf("/")+1),s=s.substring(0,s.lastIndexOf(".")),s=s.replace(new RegExp("[^\\w\\d-_]","g"),""),y[s]={type:"image",id:s,extension:o,data:e.target.result},b.val(r.substring(0,t)+"{{image "+s+"}}"+r.substring(i)),n(),a(y[s],l)},e.readAsDataURL(l[0].files[0])}),l.trigger("click")}}),h.on("submit",function(){var i=e('<input name="text_original" type="hidden" />'),r=e('<input name="text_html" type="hidden" />');h.append(i),h.append(r),i.val(s(b.val(),!0)),r.val(t.filterText(s(b.val(),!0)))}),t.text.length>0&&(b.text(t.text),m.html(t.filterText(s(t.text)))),this}}(jQuery);